<body>
    <div id="lineChart"></div>
    <div class="col-sm-6 col-sm-offset-3"><button id="group1" type="button" class="selected">Employment Rate</button><button id="group2" type="button">Hukou</button><button id="group3" type="button">Gender</button></div>
</body>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>

<script type="text/javascript">

var marginLine = {top:12, bottom:40, left:80, right:80};

var widthLine = parseInt(d3.select("#lineChart").style("width")) - marginLine.left - marginLine.right;
var heightLine = parseInt(d3.select("#lineChart").style("width")) - marginLine.top - marginLine.bottom;

var  xScaleLine = d3.scale.ordinal().rangeRoundBands([0, widthLine],1),
     yScaleLine = d3.scale.linear().range([0, heightLine]);

var svgLine = d3.select("#lineChart")
    .append("svg")
    .attr("class","lineChart")
    .attr("width",widthLine + marginLine.left + marginLine.right)
    .attr("height",heightLine + marginLine.top + marginLine.bottom)
    .append("g")
    .attr("transform","translate(" + marginLine.left + "," + marginLine.top + ")");

/*var xAxisLine = d3.svg.axis()
    .scale(xScaleLine)
    .orient("bottom")
    .ticks(5)
    .tickPadding([8])
    .tickSize([5]);

var yAxisLine = d3.svg.axis()
    .scale(yScaleLine)
    .orient("right")
    .ticks(4)
    .tickFormat(function(d) { return d*100 +"%"; })
    .tickPadding([-widthLine-7])
    .tickSize([widthLine]);*/

var line = d3.svg.line()
    .x(function(d){
        return xScaleLine(d.age);
    })
    .y(function(d){
        return yScaleLine(d.amount);
    });


d3.csv("employmentRate.csv", function(error, data) {
                if (error) {
                    console.log("Had an error loading file.");
                }else{
                var ages = d3.keys(data[0]).slice(0,8);
                var schemes = d3.keys()
                
                var dataset = [];
                
                data.forEach(function(d,i){
                    var employmentRates = [];
                    ages.forEach(function(y){
                        if(d[y]){
                            employmentRates.push({
                                scheme: d.scheme,
                                age: y,
                                amount: d[y]
                            });
                        }
                    });

                    dataset.push({
                        scheme: d.scheme,
                        rates: employmentRates
                    });
                });

                xScaleLine.domain(ages.map(function(d) { 
                            return d; 
                        }));

                function getVal(myScheme){
                    return dataset.filter(function(d){
                        return d.scheme == myScheme;
                    });
                };

                var curData = d3.merge([getVal("Total"), getVal("Total"), getVal("Total"), getVal("Total")]); 
                
                yScaleLine.domain([d3.max(curData, function(d){
                    return d3.max(d.rates, function(d){
                        return +d.amount;
                    });
                })*1.2, 0]);

                var groups = svgLine.selectAll("g.line")
                    .data(curData)
                    .enter()
                    .append("g")
                    .attr("class", "line")
                    .attr("stroke", "black");
                 

                /*var pathLine = groups.selectAll("path")
                    .data(function(d){return [d.rates];})
                    .enter()
                    .append("path")
                    .attr("class","line")
                    .attr("d",line);*/
                
/*                var gxAxis = svgLine.append("g")
                    .call(xAxisLine)
                    .attr("class","x axis lineChart")
                    .attr("transform","translate(0," + heightLine + ")");
                
                var gyAxis = svgLine.append("g")
                    .call(yAxisLine)
                    .attr("class","y axis lineChart")
                    .selectAll("text")
                    .style("text-anchor","end");*/

                svgLine.select(".y.axis")
                    .append("line")
                    .attr("x2",widthLine)
                    .attr("y2",0);
                

                var circleLine = groups.selectAll("circle")
                    .data(function(d){return d.rates;})
                    .enter()
                    .append("circle")
                    .attr("cx",function(d){return xScaleLine(+d.age);})
                    .attr("cy",function(d){return yScaleLine(+d.amount);})
                    .attr("r",1.5);

                var textLine = groups.selectAll("text.dotVal")
                    .data(function(d){return d.rates;})
                    .enter()
                    .append("text")
                    .attr("class","dotVal notDisp")
                    .attr("x",function(d){return xScaleLine(+d.age);})
                    .attr("y",function(d){return yScaleLine(+d.amount);})
                    .attr("dy", -10)
                    .style("text-anchor", "middle")
                    .text(function(d){
                        return d.amount;
                    });

                /*var labelLine = groups.append("text")
                    .datum(function(d){
                        return {
                            scheme: d.scheme, 
                            lastRates: d.rates[d.rates.length - 1].amount
                        };
                    })
                    .attr("x", widthLine)
                    .attr("y", function(d){
                        return yScaleLine(+d.lastRates);
                    })
                    .text(function(d){
                            return d.scheme;
                    })
                    .attr("class", "label")
                    .style("text-anchor","start")
                    .attr("dx",8)
                    .attr("dy",4);*/

                groups
                    .on("mouseover",mouseOverFunc)
                    .on("mouseout",mouseOutFunc);

                d3.selectAll("button").on("click",function(d){
                    if(d3.select(this).attr("id") == "group1")
                        var newData = d3.merge([getVal("Total"), getVal("Total"),getVal("Total"),getVal("Total")]);
                    else if(d3.select(this).attr("id") == "group2")
                        var newData = d3.merge([getVal("Rural"),getVal("Rural"),getVal("Urban"),getVal("Urban")]);
                    else if(d3.select(this).attr("id") == "group3")
                        var newData = d3.merge([getVal("Rural_Male"),getVal("Rural_Female"),getVal("Urban_Male"),getVal("Urban_Female")]);


/*                    d3.select(".y.axis.lineChart")
                        .transition()
                        .duration(1500)
                        .call(yAxisLine)
                        .selectAll("text")
                        .style("text-anchor","end");*/
                    
                    d3.selectAll("button").classed("selected", false);
                    d3.select(this).classed("selected", true);
                    d3.selectAll("g.line")
                        .select("path")
                        .transition()
                        .duration(1500)
                        .attr("d",function(d,i){
                            return line(newData[i].rates);
                        })
                        .attr("stroke", function(d,i,j){
                            if(newData[i].rates[j].scheme.startsWith("R")){
                                console.log("rural line");return "red";
                            }
                            else if(newData[i].rates[j].scheme.startsWith("U")){
                                console.log("rural line");return "blue";
                            }
                        });
 
                    d3.selectAll("g.line")
                        .select("text.label")
                        .transition()
                        .duration(1500)
                        .attr("y",function(d,i){
                            var lastRates = newData[i].rates[newData[i].rates.length - 1].amount;
                            return yScaleLine(+lastRates);
                        })
                        .text(function(d,i){
                                return newData[i].scheme;
                        })
                        .attr("stroke", function(d,i,j){
                            if(newData[i].rates[j].scheme.startsWith("R")){
                                console.log("rural line");return "red";
                            }
                            else if(newData[i].rates[j].scheme.startsWith("U")){
                                console.log("rural line");return "blue";
                            }
                        });
                    
                    groups.selectAll("circle")
                        .data(function(d,i){
                            return newData[i].rates;})
                        .transition()
                        .duration(1500)
                        .attr("cy",function(d){return yScaleLine(+d.amount);})
                        .attr("r",1.5);

                    groups.selectAll("text.dotVal")
                        .data(function(d,i){
                            return newData[i].rates;})
                        .transition()
                        .duration(1500)
                        .attr("y",function(d){return yScaleLine(+d.amount);})
                        .attr("dy", -10)
                        .text(function(d){
                            return d.amount;
                        });
                });


                function resize(){

                     var widthLine = parseInt(d3.select("#lineChart").style("width")) - marginLine.left - marginLine.right;
                     var heightLine = parseInt(d3.select("#lineChart").style("width")) - marginLine.top - marginLine.bottom;

                      xScaleLine.rangeRoundBands([0, widthLine],1);
                         yScaleLine.range([0, heightLine]);

                     svgLine
                        .attr("width",widthLine + marginLine.left + marginLine.right)
                        .attr("height",heightLine + marginLine.top + marginLine.bottom)
                        .attr("transform","translate(" + marginLine.left + "," + marginLine.top + ")");

                    var xAxisLine = d3.svg.axis()
                        .scale(xScaleLine)
                        .orient("bottom")
                        .ticks(5)
                        .tickPadding([8])
                        .tickSize([5]);

                    var yAxisLine = d3.svg.axis()
                        .scale(yScaleLine)
                        .orient("right")
                        .ticks(4)
                        .tickFormat(function(d) { return d*100 +"%"; })
                        .tickPadding([-widthLine-7])
                        .tickSize([widthLine]);

                    line
                        .x(function(d){
                            return xScaleLine(d.age);
                        })
                        .y(function(d){
                            return yScaleLine(d.amount);
                        });
            
                    svgLine.append("g")
                        .call(xAxisLine)
                        .attr("class","x axis lineChart")
                        .attr("transform","translate(0," + heightLine + ")");
                    
                    svgLine.append("g")
                        .call(yAxisLine)
                        .attr("class","y axis lineChart")
                        .selectAll("text")
                        .style("text-anchor","end");

                    var pathLine = groups.selectAll("path")
                    .data(function(d){return [d.rates];})
                    .enter()
                    .append("path")
                    .attr("class","line")
                    .attr("d",line);

                     circleLine
                        .attr("cx",function(d){return xScaleLine(+d.age);})
                        .attr("cy",function(d){return yScaleLine(+d.amount);});

                     textLine
                        .attr("x",function(d){return xScaleLine(+d.age);})
                        .attr("y",function(d){return yScaleLine(+d.amount);});

                    groups.append("text")
                        .datum(function(d){
                            return {
                                scheme: d.scheme, 
                                lastRates: d.rates[d.rates.length - 1].amount
                            };
                        })
                        .attr("x", widthLine)
                        .attr("y", function(d){
                            return yScaleLine(+d.lastRates);
                        })
                        .text(function(d){
                                return d.scheme;
                        })
                        .attr("class", "label")
                        .style("text-anchor","start")
                        .attr("dx",8)
                        .attr("dy",4);





            }; //end for resize

            d3.select(window).on("resize", resize);
            resize();

                }; //end for else
 

            }); //end for d3.csv
            
            function mouseOverFunc(d){
                d3.selectAll("g.line")
                    .classed("unfocused", true)
                    .selectAll("circle").attr("r",1);
                d3.select(this)
                    .classed("focused", true)
                    .classed("unfocused", false)
                    .selectAll("circle").attr("r",3);
                d3.select(this).selectAll("text").style("display", "block");
            }
            
            function mouseOutFunc(d){
                d3.selectAll("g.line")
                    .classed("unfocused",false)
                    .classed("focused",false)
                    .selectAll("circle").attr("r",1.5);
                d3.selectAll("g.line").selectAll("text").style("display", null);
            }




</script>
    <style>
    #lineChart {
        width: 50%;
        height: 50%;

    }


        body{
            font-family: 'Open Sans', sans-serif;
        }
        h1{
            font-family: 'Roboto', sans-serif;
            text-align: center;
            margin: 40px;
        }
        
        #lineChart{
            margin: auto;
            width: 700px;
        }
        .axis text{
            font-family: 'Roboto', sans-serif;
            fill: #444;
            font-size: 14px;
        }
        .y.axis path{
            fill: none;
            stroke: none;
            shape-rendering: crispEdges;
        }
        .axis line {
            fill: none;
            stroke: #999;
            shape-rendering: crispEdges;
        }
        
        .chart .x.axis path{
            fill: none;
            stroke: none;
        }
        .bars:hover{
            fill: #E3314C;
        }
        .value{
            font-size: 12px;
            color: #444;
        }
        path.line{
            fill: none;
            stroke-width: 1.5px;
            transition: 0.1s;
        }
/*        g.urban path.line{
            stroke: #418FC6;
        }
        g.rural path.line{
            stroke: #E3314C;
        }
        g.total path.line{
            stroke: black;
        }*/
        g.urban circle{
            fill: #418FC6;
            transition: 0.1s;
        }
        g.rural circle{
            fill: #E3314C;
            transition: 0.1s;
        }
        g.line{
            opacity: 0.8;
        }
        g.line.unfocused{
            opacity: 0.5;
        }
        g.line.focused{
            opacity: 1;
        }
        g.line.unfocused path.line{
            stroke-width: 1px;
        }
        g.line.focused path.line{
            stroke-width: 3px;
        }
        g.line text.label{
            font-family: 'Roboto', sans-serif;
            font-size: 12px;
            font-weight: lighter;
            cursor: pointer;
        }
        g.line.bmw text{
            fill: #418FC6;
        }
        g.line.audi text{
            fill: #E3314C;
        }
        g.line text.notDisp{
            display: none;
        }
        text.dotVal{
            font-family: 'Open Sans', sans-serif;
            font-size: 12px;
        }
        .tick text{
            text-anchor: end;
        }
        .lineChart .y .tick line{
            stroke-dasharray: 2,5;
        }
        .lineChart .x.axis path{
            fill: none;
            stroke: #999;
        }
/*        .barChart .x .tick line{
            stroke-dasharray: 2,5;
        }
        .barChart .x .tick:first-child line, .barChart .x .tick:nth-last-child(2) line{
            stroke-dasharray: 5,0;
        }*/
        button{
            background: #fff;
            color: #E3314C;
            border: 1px solid #E3314C;
            padding: 7px;
            padding-top: 5px;
            padding-bottom: 5px;
            border-radius: 4px;
            outline: none;
            margin-right: 10px;
            font-size: 12px;
        }
        button:hover{
            background: #ffcccc;
            cursor: pointer;
        }
        button.selected{
            background: #E3314C;
            color: #fff;
        }
        select{
            background: #fff;
            color: #E3314C;
            border: 1px solid #E3314C;
            padding: 7px;
            padding-top: 5px;
            padding-bottom: 5px;
            border-radius: 4px;
            outline: none;
            margin-right: 10px;
            font-size: 12px;
        }
    </style>
 